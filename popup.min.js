window.zendoConfig={width:400,fontSize:12,color1:"#ff3b30",color2:"#ffcc00",color3:"#34c759"};const storageKey="todoGroups",mainView=document.getElementById("main-view"),groupView=document.getElementById("group-view"),groupList=document.getElementById("group-list"),newGroupInput=document.getElementById("new-group"),groupTitle=document.getElementById("group-title"),newTaskInput=document.getElementById("new-task"),taskList=document.getElementById("task-list"),backButton=document.getElementById("back-button");let dynamicStyleTag=null;function applyConfig(e){e.width&&(document.body.style.width=`${e.width}px`),e.fontSize&&document.querySelectorAll("#group-list li, #task-list li").forEach((t=>{t.style.fontSize=`${e.fontSize}px`})),dynamicStyleTag&&dynamicStyleTag.remove();const t=document.createElement("style");t.innerHTML=`\n    :root {\n      --color-priority-red: ${e.color1||"#ff3b30"};\n      --color-priority-yellow: ${e.color2||"#ffcc00"};\n      --color-priority-green: ${e.color3||"#34c759"};\n    }\n\n    .priority-red { color: var(--color-priority-red) !important; }\n    .priority-yellow { color: var(--color-priority-yellow) !important; }\n    .priority-green { color: var(--color-priority-green) !important; }\n\n    select.priority-select option.priority-red { color: var(--color-priority-red) !important; }\n    select.priority-select option.priority-yellow { color: var(--color-priority-yellow) !important; }\n    select.priority-select option.priority-green { color: var(--color-priority-green) !important; }\n  `,document.head.appendChild(t),dynamicStyleTag=t}const pencilBtn='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9" /><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" /></svg>';let currentGroup=null;function save(e){chrome.storage.sync.set({[storageKey]:e})}function load(e){chrome.storage.sync.get([storageKey],(t=>{e(t[storageKey]||{})}))}function renderGroupList(e){groupList.innerHTML="";for(const t in e){const n=document.createElement("li");window.zendoConfig?.fontSize&&(n.style.fontSize=`${window.zendoConfig.fontSize}px`),n.textContent=t,n.style.cursor="pointer",n.addEventListener("click",(()=>{currentGroup=t,switchToGroupView(e)})),n.draggable=!0,n.addEventListener("dragstart",(e=>{e.dataTransfer.setData("text/plain",t),n.classList.add("dragging")})),n.addEventListener("dragend",(()=>{n.classList.remove("dragging")})),n.addEventListener("dragover",(e=>{e.preventDefault()})),n.addEventListener("drop",(n=>{n.preventDefault();const r=n.dataTransfer.getData("text/plain"),o=t,i={},a=Object.keys(e),d=a.indexOf(r),l=a.indexOf(o);a.splice(l,0,a.splice(d,1)[0]),a.forEach((t=>i[t]=e[t])),save(sanitize(i)),renderGroupList(i)}));const r=document.createElement("button");r.textContent="x",r.addEventListener("click",(n=>{n.stopPropagation(),delete e[t],save(sanitize(e)),renderGroupList(e)})),n.appendChild(r),groupList.appendChild(n)}}function renderTasks(e,t){document.getElementById("current-group-name").textContent=currentGroup,taskList.innerHTML="",e.forEach(((n,r)=>{const o=document.createElement("li");o.draggable=!0;const i=document.createElement("button");i.innerHTML=pencilBtn,i.addEventListener("click",(n=>{n.stopPropagation(),e[r].editing=!0,save(sanitize(t)),t[currentGroup]&&renderTasks(t[currentGroup],t)})),o.appendChild(i);const a=document.createElement("button");a.textContent="🗐",a.addEventListener("click",(e=>{e.stopPropagation(),navigator.clipboard.writeText(n.text)})),o.appendChild(a);const d=document.createElement("select");d.className="priority-select",["red","yellow","green","black"].forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent="●",t.className=`priority-${e}`,n.priority===e&&(t.selected=!0),d.appendChild(t)})),d.addEventListener("change",(()=>{n.priority=d.value,save(sanitize(t)),t[currentGroup]&&renderTasks(t[currentGroup],t)})),o.appendChild(d);const l=document.createElement("button");l.textContent="x",l.addEventListener("click",(n=>{n.stopPropagation(),e.splice(r,1),save(sanitize(t)),t[currentGroup]&&renderTasks(t[currentGroup],t)})),o.appendChild(l),o.addEventListener("dragstart",(e=>{o.classList.add("dragging"),e.dataTransfer.setData("text/plain",r)})),o.addEventListener("dragend",(()=>{o.classList.remove("dragging")})),o.addEventListener("dragover",(e=>{e.preventDefault()})),o.addEventListener("drop",(n=>{n.preventDefault();const o=parseInt(n.dataTransfer.getData("text/plain"),10),i=r,a=e.splice(o,1)[0];e.splice(i,0,a),save(sanitize(t)),t[currentGroup]&&renderTasks(t[currentGroup],t)}));const s=document.createElement("div");if(s.className="button-group",s.appendChild(i),s.appendChild(a),s.appendChild(d),s.appendChild(l),o.appendChild(s),n.editing){const i=document.createElement("textarea");i.value=n.text,i.className="edit-input",i.style.resize="vertical",i.style.width="100%",i.rows=3,i.addEventListener("input",(()=>{i.style.height="auto",i.style.height=i.scrollHeight+"px"})),i.addEventListener("keydown",(n=>{"Enter"!==n.key||n.shiftKey?"Escape"===n.key&&(n.preventDefault(),n.stopPropagation(),delete e[r].editing,t[currentGroup]&&renderTasks(t[currentGroup],t)):(n.preventDefault(),e[r].text=i.value.trim(),delete e[r].editing,save(sanitize(t)),t[currentGroup]&&renderTasks(t[currentGroup],t))})),o.appendChild(i);const s=document.createElement("button");s.textContent="↩ Cancel",s.title="Cancel edit",s.style.fontSize="12px",s.style.padding="4px 6px",s.style.borderRadius="6px",s.style.border="none",s.style.background="#e5e5ea",s.style.cursor="pointer",s.addEventListener("click",(()=>{delete e[r].editing,renderTasks(t[currentGroup],t)}));const c=document.createElement("div");c.className="button-group",c.appendChild(s),c.appendChild(a),c.appendChild(d),c.appendChild(l),o.appendChild(c)}else{let e,r=!1;try{const e=new URL(n.text);r="http:"===e.protocol||"https:"===e.protocol}catch(e){r=!1}r?(e=document.createElement("a"),e.href=n.text,e.target="_blank",e.rel="noopener noreferrer",e.textContent=n.text,e.className="task-url"):(e=document.createElement("span"),e.textContent=n.text,e.className="task-text",e.addEventListener("click",(()=>{n.done=!n.done,save(sanitize(t)),renderTasks(t[currentGroup],t)}))),e.style.flex="1",n.done&&e.classList.add("completed"),n.priority&&e.classList.add(`priority-${n.priority}`),e.addEventListener("click",(()=>{n.done=!n.done,save(sanitize(t)),t[currentGroup]&&renderTasks(t[currentGroup],t)})),o.appendChild(e),s.appendChild(i),s.appendChild(a),s.appendChild(d),s.appendChild(l),o.appendChild(s)}window.zendoConfig?.fontSize&&(o.style.fontSize=`${window.zendoConfig.fontSize}px`),taskList.appendChild(o)})),document.getElementById("clear-completed").onclick=()=>{const n=e.filter((e=>!e.done));t[currentGroup]=n,save(sanitize(t)),renderTasks(n,t)}}function switchToMainView(e){groupView.style.display="none",mainView.style.display="block",document.getElementById("task-header").style.display="none",renderGroupList(e)}function switchToGroupView(e){mainView.style.display="none",groupView.style.display="block",document.getElementById("task-header").style.display="flex",renderTasks(e[currentGroup],e),renderGroupNameWrapper()}function sanitize(e){const t={};for(const n in e)t[n]=e[n].map((e=>{const{text:t,done:n,priority:r}=e;return{text:t,done:n,priority:r}}));return t}function renderGroupNameWrapper(){const e=document.getElementById("group-name-wrapper");e.innerHTML="";const t=document.createElement("h3");t.id="current-group-name",t.textContent=currentGroup,t.style.margin="0";const n=document.createElement("button");n.id="edit-group-name",n.title="Edit group name",n.style.border="none",n.innerHTML=pencilBtn,n.onclick=initGroupEdit,e.appendChild(t),e.appendChild(n)}function initGroupEdit(){const e=document.getElementById("group-name-wrapper");e.innerHTML="";const t=document.createElement("input");t.type="text",t.value=currentGroup,t.style.flexGrow="1";const n=document.createElement("button");n.textContent="✔",n.title="Save group name",n.onclick=()=>{const e=t.value.trim();load(e&&e!==currentGroup?t=>{if(t[e])return alert("Group already exists!");t[e]=t[currentGroup],delete t[currentGroup],currentGroup=e,save(sanitize(t)),renderGroupNameWrapper()}:renderGroupNameWrapper)},e.appendChild(t),e.appendChild(n),t.focus(),t.select()}newGroupInput.addEventListener("keydown",(e=>{if("Enter"===e.key&&newGroupInput.value.trim()){const e=newGroupInput.value.trim();load((t=>{t[e]||(t[e]=[],save(sanitize(t)),renderGroupList(t))})),newGroupInput.value=""}})),newTaskInput.addEventListener("keydown",(e=>{if("Enter"===e.key&&newTaskInput.value.trim()){const e=newTaskInput.value.trim();load((t=>{t[currentGroup].push({text:e,done:!1,priority:"black"}),save(sanitize(t)),renderTasks(t[currentGroup],t)})),newTaskInput.value=""}})),backButton.addEventListener("click",(()=>{load(switchToMainView)})),document.getElementById("edit-group-name").addEventListener("click",initGroupEdit),document.getElementById("help-button").addEventListener("click",(()=>{document.getElementById("help-modal").style.display="block"})),document.getElementById("close-help").addEventListener("click",(()=>{document.getElementById("help-modal").style.display="none"})),document.getElementById("settings-button").addEventListener("click",(()=>{chrome.runtime.openOptionsPage()})),document.addEventListener("DOMContentLoaded",(()=>{chrome.storage.sync.get(["zendoConfig"],(e=>{applyConfig(e.zendoConfig||{}),load((e=>{for(const t in e)e[t].forEach((e=>delete e.editing));switchToMainView(e)}))})),newGroupInput.addEventListener("keydown",(e=>{if("Enter"===e.key&&newGroupInput.value.trim()){const e=newGroupInput.value.trim();load((t=>{t[e]||(t[e]=[],save(sanitize(t)),renderGroupList(t))})),newGroupInput.value=""}})),newTaskInput.addEventListener("keydown",(e=>{if("Enter"===e.key&&newTaskInput.value.trim()){const e=newTaskInput.value.trim();load((t=>{t[currentGroup].push({text:e,done:!1,priority:"black"}),save(sanitize(t)),renderTasks(t[currentGroup],t)})),newTaskInput.value=""}})),backButton.addEventListener("click",(()=>{load(switchToMainView)})),document.getElementById("help-button").addEventListener("click",(()=>{document.getElementById("help-modal").style.display="block"})),document.getElementById("close-help").addEventListener("click",(()=>{document.getElementById("help-modal").style.display="none"})),document.getElementById("settings-button").addEventListener("click",(()=>{chrome.runtime.openOptionsPage()}))})),chrome.storage.onChanged.addListener(((e,t)=>{if("sync"===t&&e.zendoConfig){const t=e.zendoConfig.newValue;window.zendoConfig=t,applyConfig(t),load((e=>{"block"===groupView.style.display?renderTasks(e[currentGroup],e):renderGroupList(e)}))}}));